---
title: "recoilã‚’ç†è§£ã™ã‚‹"
emoji: "ğŸ¤–"
type: "tech"
topics: ["recoil", "React"]
published: true
---

ä»Šæ›´ãªãŒã‚‰recoilã‚’å‹‰å¼·ã—ãŸã®ã§ã€ãã®ã¾ã¨ã‚ã‚’æ›¸ãã¾ã™ã€‚
æ‰€æ„Ÿã¨ã—ã¦ã¯ã€reduxã‚ˆã‚Šã‚‚æ›¸ãã‚„ã™ãã€å­¦ç¿’ã‚³ã‚¹ãƒˆã‚‚ä½ã„ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚
åŸºæœ¬çš„ã«ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«èª¬æ˜ã—ã¾ã™ã®ã§ã€ãã¡ã‚‰ã‚‚ä½µã›ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
å½“ãŸã‚Šå‰ã®ã€`yarn add recoil`ã€‚ã‚‚ã—ãã¯`npm install recoil`ã€‚
ãã®ä¸Šã§ã€RecoilRootã§å›²ã£ã¨ãã¾ã—ã‚‡ã†ã€‚

```tsx
import { RecoilRoot } from "recoil";

export const App: React.FC = () => {
  return (
    <RecoilRoot>
      <Component />
    </RecoilRoot>
  );
};
```

ã“ã‚Œã§RecoilRooté…ä¸‹ã§recoilãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## åŸºæœ¬æ¦‚å¿µ
### Atom
recoilã§ã¯Atomã¨ã„ã†å˜ä½ãŒæœ€å°å˜ä½ã¨ãªã‚Šã¾ã™ã€‚
Atomã¯1ã¤ã®stateã‚’æ„å‘³ã—ã¾ã™ã€‚

```tsx
import { atom } from "recoil";

export const UserName = atom({
  key: "UserName",
  default: "",
});
```

ä¸Šè¨˜ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€Userã®åå‰ã‚’æƒ³å®šã—ãŸatomã§ã™ã€‚
keyã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®æ–‡å­—åˆ—ã‚’è¨­å®šã—ã€defaultã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã™ã€‚

### selector
selectorã«ã¯ã€stateã‚’æ›´æ–°ã—ãŸã‚ŠåŠ å·¥ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx
const selector = selector<T>({
  key: "uniqueKey",
  get: ({ get }) => {
    // å¼•æ•°ã«atomã‚„selectorã‚’å…¥ã‚Œã¦ç¾åœ¨ã®stateã‚’å–å¾—ã€‚ãã®ä¸Šã§atomã‚’åˆ©ç”¨ã—ãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã€‚
    get(atom);
  },
  set: ({ set }, newValue) => {
    // ç¬¬ä¸€å¼•æ•°ã«atomã‚’æŒ‡å®šã—ã€ç¬¬äºŒå¼•æ•°ã«å‘¼ã³å‡ºã—å´ã§å…¥åŠ›ã—ãŸå€¤ãŒå…¥ã‚‹ã€‚
    set(atom, newValue);
  }
});
```

ãã®ä»–è¨­å®šå¯èƒ½ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã®ã§ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
https://recoiljs.org/docs/api-reference/core/selector


## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰å‘¼ã³å‡ºã™æ–¹æ³•
ä»¥ä¸‹ã®ä¸‰ã¤ãŒã‚ã‚Šã¾ã™ã€‚
åŸºæœ¬çš„ã«ã¯åå‰ã‹ã‚‰æƒ³åƒã§ãã‚‹é€šã‚Šã§ã™ã€‚

- useRecoilState
- useRecoilValue
- useSetRecoilState

useRecoilStateã¯useStateã¨ã»ã¼åŒã˜ã§ã™ã€‚
å¼•æ•°ã«atomã‚„selectorãªã©ã®RecoilStateã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€stateã¨setStateã‚’å¾—ã¾ã™ã€‚

```tsx
const age = atom({
  key: "age",
  default: 0
})

const Component = () => {
  const [age, setAge] = useRecoilState(age);
  return <p>{age}æ­³</p>;
}
```
useRecoilValueã¯å€¤ã®å‚ç…§ã®ã¿ã€useSetRecoilStateã¯æ›´æ–°ã®ã¿ã«ãªã‚Šã¾ã™ã€‚

## éåŒæœŸå‡¦ç†
selectorã§éåŒæœŸã§å€¤ã‚’å–å¾—ã™ã‚‹ä¾‹ãŒå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚Šã¾ã—ãŸã€‚
ä»¥ä¸‹ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å¼•ç”¨ã—ãŸã‚‚ã®ã§ã™ãŒã€ç°¡å˜ã«å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
https://recoiljs.org/docs/api-reference/core/selector/#example-asynchronous


```tsx
import { selector, useRecoilValue } from 'recoil';

// selectorã§éåŒæœŸã§å€¤ã‚’å–å¾—
const myQuery = selector({
  key: 'MyDBQuery',
  get: async () => {
    const response = await fetch(getMyRequestUrl());
    return response.json();
  },
});

const QueryResults = () => {
  const queryResults = useRecoilValue(myQuery);
  return (
    <div>
      {queryResults.foo}
    </div>
  );
}

const ResultsSection = () => {
  return (
    <React.Suspense fallback={<div>Loading...</div>}>
      <QueryResults />
    </React.Suspense>
  );
}
```

ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸå ´åˆã¯ã€ErrorBoundryã‚’å®šç¾©ã—ã‚¨ãƒ©ãƒ¼ç”¨ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹æ–¹æ³•ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://reactjs.org/docs/error-boundaries.html

## atomFamilyã¨selectorFamily
atomFamilyã¨selectorFamilyã‚’ä½¿ã†ã“ã¨ã§ã€å‹•çš„ã«atomã‚„selectorã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€APIã§ãƒ•ã‚§ãƒƒãƒã—ã¦ããŸè¤‡æ•°è¦ç´ ã‚ã‚‹é…åˆ—ã®å€¤ã‚’ãã‚Œãã‚Œã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§stateã¨ã—ã¦ç®¡ç†ã—ãŸã„æ™‚ã«ä½¿ãˆã¾ã™ã€‚

```tsx
import React, { useEffect } from "react";
import {
  atomFamily,
  DefaultValue,
  selectorFamily,
  useRecoilCallback,
  useRecoilState,
} from "recoil";

export type Item = {
  id: string;
  title: string;
  content: string;
};

type Props = {
  items: Item[];
};

// fetchã—ã¦ããŸãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚‹ã¨ä»®å®š
export const Component: React.FC<Props> = ({ items }) => {
  const setState = useRecoilCallback(({ set }) => (itemValues: Item[]) => {
    itemValues.forEach((item) => {
      set(itemSelector(item.id), item);
    });
  });

  useEffect(() => {
    setState(items);
  }, [items, setState]);

  return (
    <div>
      {items.map((item, i) => {
        return <ItemComponent key={i} item={item} />;
      })}
    </div>
  );
};

const titleAtom = atomFamily<Item["title"], Item["id"]>({
  key: "title",
  default: "",
});

const contentAtom = atomFamily<Item["content"], Item["id"]>({
  key: "content",
  default: "",
});

export const itemSelector = selectorFamily<Item, Item["id"]>({
  key: "itemSelector",
  get:
    (itemId) =>
    ({ get }) => {
      return {
        id: itemId,
        title: get(titleAtom(itemId)),
        content: get(contentAtom(itemId)),
      };
    },
  set:
    (itemId) =>
    ({ set }, newValue) => {
      if (newValue instanceof DefaultValue) return;
      set(titleAtom(itemId), newValue.title);
      set(contentAtom(itemId), newValue.content);
    },
});

export const ItemComponent: React.FC<{ item: Item }> = ({ item }) => {
  // itemã®æ•°ã ã‘ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªstateã¨ã—ã¦å‹•çš„ã«å±•é–‹ã•ã‚Œã‚‹
  const [itemState, setItemState] = useRecoilState(itemSelector(item.id));
  return <p>{item.title}</p>;
};
```


## useRecoilCallBack
useRecoilCallBackã¯useCallBackã¨ä¼¼ã¦ã„ã¾ã™ã€‚
useRecoilCallBackã¯ãƒ¡ãƒ¢åŒ–ã—ãŸcallbacké–¢æ•°ã‚’è¿”ã—ã¦ã€callbacké–¢æ•°å†…ã§stateã‚’èª­ã¿æ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
è©³ã—ãã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”è¦§ãã ã•ã„ã€‚
https://recoiljs.org/docs/api-reference/core/useRecoilCallback/

## ã¾ã¨ã‚
æœ€è¿‘reduxãŒã‚ã‚“ã©ãã•ããªã£ã¦ããŸç«‹å ´ã¨ã—ã¦ã€recoilã¯è‰²ã€…å¯èƒ½æ€§ã‚’æ„Ÿã˜ã¾ã—ãŸã€‚
æ›¸ãã®ã‚‚æ¥½ãã†ã§ã™ã€‚

èª¿ã¹ã¦æ›¸ã„ã¦ã„ãä¸­ã§ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ä½¿ã£ãŸã‚Šã€Reactã‚’ä½¿ã„ã“ãªã›ã¦ã„ãªã„ã¨ãªã‹ãªã‹å³ã—ã„å ´é¢ã‚‚ã‚ã‚Šãã†ã ãªã¨æ„Ÿã˜ãŸã®ã§ã€æ™®æ®µã®hooksã«ä¸å®‰ãŒã‚ã‚‹çŠ¶æ…‹ã§å…¥é–€ã™ã‚‹ã®ã¯å¾®å¦™ãã†ã§ã™ã€‚

ã¾ã expelimentalã£ã½ã„ã®ã§ã€ä»Šå¾Œã‚‚æ³¨ç›®ã—ã¾ã—ã‚‡ã†ã€‚

## å‚è€ƒæ–‡çŒ®
https://recoiljs.org/
https://github.com/facebookexperimental/Recoil
https://qiita.com/itachi/items/02688096bc5734396e8e
https://zenn.dev/susiyaki/articles/95dea88e673e1f854130
https://sbfl.net/blog/2020/05/17/react-experimental-recoil-usage/
